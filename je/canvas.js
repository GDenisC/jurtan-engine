var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { images } from "./images.js";
import { Point } from "./math.js";
export const getCanvasInstance = () => {
    if (!Canvas.instance) {
        throw new Error('Canvas not initialized');
    }
    return Canvas.instance;
};
export const getInstances = () => getCanvasInstance().instances;
export class Canvas {
    constructor(options) {
        this.instances = [];
        this.backgroundColor = 'rgb(30, 30, 30)';
        if (!Canvas.instance)
            Canvas.instance = this;
        else
            throw new Error('Canvas instance already exists, use getCanvasInstance() instead of new Canvas().');
        this.options = options || {
            width: 1366,
            height: 768
        };
        this.tag = document.getElementById('canvas');
        if (!this.tag)
            throw new Error('Canvas not found');
        if (!this.options.fullscreen) {
            this.tag.width = this.options.width * this.ratio;
            this.tag.height = this.options.height * this.ratio;
        }
        else {
            this.tag.width = 1920;
            this.tag.height = 1280;
        }
        this.ctx = this.tag.getContext('2d');
        if (!this.ctx)
            throw new Error('Canvas context not found');
        this.camera = new Point(0, 0);
        this.init();
    }
    init() {
        var _a, _b;
        window.addEventListener('resize', () => this.resizeWindow());
        this.resizeWindow();
        this.tag.addEventListener('contextmenu', e => e.preventDefault());
        this.tag.style.imageRendering = (_a = this.options.render) !== null && _a !== void 0 ? _a : 'auto';
        this.ctx.imageSmoothingEnabled = (_b = this.options.smooth) !== null && _b !== void 0 ? _b : false;
    }
    resizeWindow() {
        const { width, height } = this.realSize;
        if (!this.options.fullscreen) {
            this.tag.width = this.options.width * this.ratio;
            this.tag.height = this.options.height * this.ratio;
            this.tag.style.width = `${width}px`;
            this.tag.style.height = `${height}px`;
            this.tag.style.top = `${window.innerHeight / 2 - height / 2}px`;
            this.tag.style.left = `${window.innerWidth / 2 - width / 2}px`;
        }
        else {
            this.tag.style.width = `${window.innerWidth}px`;
            this.tag.style.height = `${window.innerHeight}px`;
        }
    }
    loadAllImages() {
        return new Promise(resolve => {
            Promise.all(images.map(i => {
                if (!i.complete) {
                    return new Promise((resolve, reject) => {
                        console.log('Loading image', i.src);
                        i.onload = () => resolve(i);
                        i.onerror = () => reject(i);
                    });
                }
                return null;
            }).filter(i => i != null))
                .then(res => resolve(res))
                .catch(img => img.src = '');
        });
    }
    renderLoop() {
        const ctx = this.ctx;
        ctx.fillStyle = this.backgroundColor;
        ctx.fillRect(0, 0, this.width * this.ratio, this.height * this.ratio);
        ctx.fillStyle = 'white';
        ctx.save();
        ctx.scale(this.ratio, this.ratio);
        ctx.translate(this.camera.x, this.camera.y);
        const sortedInstance = this.instances.sort((a, b) => a.depth - b.depth);
        for (const instance of sortedInstance) {
            instance._update(ctx);
        }
        ctx.restore();
        requestAnimationFrame(this.renderLoop.bind(this));
    }
    runAsync() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loadAllImages();
            this.renderLoop();
        });
    }
    start() {
        this.runAsync();
    }
    addChild(instance) {
        this.instances.push(instance);
    }
    get width() {
        return this.tag.width / this.ratio;
    }
    get height() {
        return this.tag.height / this.ratio;
    }
    get realSize() {
        return {
            width: this.ratio ? this.tag.width / this.ratio : this.tag.width,
            height: this.ratio ? this.tag.height / this.ratio : this.tag.height
        };
    }
    get center() {
        return {
            x: this.width / 2,
            y: this.height / 2
        };
    }
    get ratio() {
        return this.options.ratio ? window.devicePixelRatio : 1;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLmpzIiwic291cmNlUm9vdCI6ImplLXNyYy8iLCJzb3VyY2VzIjpbImNhbnZhcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFxQmxDLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRTtJQUNsQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtRQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7S0FDN0M7SUFDRCxPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUM7QUFDM0IsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixFQUFFLENBQUMsU0FBUyxDQUFDO0FBRWhFLE1BQU0sT0FBTyxNQUFNO0lBU2YsWUFBWSxPQUF1QjtRQUpuQyxjQUFTLEdBQWUsRUFBRSxDQUFDO1FBRTNCLG9CQUFlLEdBQUcsaUJBQWlCLENBQUM7UUFHaEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRO1lBQUUsTUFBTSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7O1lBQ3hDLE1BQU0sSUFBSSxLQUFLLENBQUMsa0ZBQWtGLENBQUMsQ0FBQTtRQUV4RyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sSUFBSTtZQUN0QixLQUFLLEVBQUUsSUFBSTtZQUNYLE1BQU0sRUFBRSxHQUFHO1NBQ2QsQ0FBQztRQUNGLElBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQXNCLENBQUM7UUFFbEUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHO1lBQ1QsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBRXhDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVB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LENBQUMsS0FBSyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDUixPQUFPO1lBQ0gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSztZQUNoRSxNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1NBQ3RFLENBQUM7SUFDTixDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTztZQUNILENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUM7WUFDakIsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQztTQUNyQixDQUFDO0lBQ04sQ0FBQztJQUVELElBQUksS0FBSztRQUNMLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluc3RhbmNlIH0gZnJvbSBcIi4vaW5zdGFuY2UuanNcIjtcbmltcG9ydCB7IGltYWdlcyB9IGZyb20gXCIuL2ltYWdlcy5qc1wiO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tIFwiLi9tYXRoLmpzXCI7XG5pbXBvcnQgeyBjcmVhdGVDb2xvciwgdG9DYW52YXNDb2xvciB9IGZyb20gXCIuL2NvbG9ycy5qc1wiO1xuXG50eXBlIENhbnZhc090aGVyT3B0aW9ucyA9IFBhcnRpYWw8e1xuICAgIHJlbmRlcjogJ3BpeGVsYXRlZCcgfCAnY3Jpc3AtZWRnZXMnLFxuICAgIHNtb290aDogYm9vbGVhbixcbiAgICByYXRpbzogYm9vbGVhblxufT47XG5cbnR5cGUgQ2FudmFzU2NyZWVuT3B0aW9ucyA9IHtcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyLFxuICAgIGZ1bGxzY3JlZW4/OiBmYWxzZVxufSAmIENhbnZhc090aGVyT3B0aW9ucztcblxudHlwZSBDYW52YXNGdWxsc2NyZWVuT3B0aW9ucyA9IHtcbiAgICBmdWxsc2NyZWVuOiB0cnVlXG59ICYgQ2FudmFzT3RoZXJPcHRpb25zO1xuXG5leHBvcnQgdHlwZSBDYW52YXNPcHRpb25zID0gQ2FudmFzU2NyZWVuT3B0aW9ucyB8IENhbnZhc0Z1bGxzY3JlZW5PcHRpb25zO1xuXG5leHBvcnQgY29uc3QgZ2V0Q2FudmFzSW5zdGFuY2UgPSAoKSA9PiB7XG4gICAgaWYgKCFDYW52YXMuaW5zdGFuY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW52YXMgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfVxuICAgIHJldHVybiBDYW52YXMuaW5zdGFuY2U7XG59XG5leHBvcnQgY29uc3QgZ2V0SW5zdGFuY2VzID0gKCkgPT4gZ2V0Q2FudmFzSW5zdGFuY2UoKS5pbnN0YW5jZXM7XG5cbmV4cG9ydCBjbGFzcyBDYW52YXMge1xuICAgIHN0YXRpYyBpbnN0YW5jZTogQ2FudmFzIHwgbnVsbDtcbiAgICBvcHRpb25zOiBDYW52YXNPcHRpb25zO1xuICAgIHRhZzogSFRNTENhbnZhc0VsZW1lbnQ7XG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG4gICAgaW5zdGFuY2VzOiBJbnN0YW5jZVtdID0gW107XG4gICAgY2FtZXJhOiBQb2ludDtcbiAgICBiYWNrZ3JvdW5kQ29sb3IgPSAncmdiKDMwLCAzMCwgMzApJztcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBDYW52YXNPcHRpb25zKSB7XG4gICAgICAgIGlmICghQ2FudmFzLmluc3RhbmNlKSBDYW52YXMuaW5zdGFuY2UgPSB0aGlzO1xuICAgICAgICBlbHNlIHRocm93IG5ldyBFcnJvcignQ2FudmFzIGluc3RhbmNlIGFscmVhZHkgZXhpc3RzLCB1c2UgZ2V0Q2FudmFzSW5zdGFuY2UoKSBpbnN0ZWFkIG9mIG5ldyBDYW52YXMoKS4nKVxuXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge1xuICAgICAgICAgICAgd2lkdGg6IDEzNjYsXG4gICAgICAgICAgICBoZWlnaHQ6IDc2OFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnRhZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYW52YXMnKSBhcyBIVE1MQ2FudmFzRWxlbWVudDtcblxuICAgICAgICBpZiAoIXRoaXMudGFnKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW52YXMgbm90IGZvdW5kJyk7XG5cbiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbikge1xuICAgICAgICAgICAgdGhpcy50YWcud2lkdGggPSB0aGlzLm9wdGlvbnMud2lkdGggKiB0aGlzLnJhdGlvO1xuICAgICAgICAgICAgdGhpcy50YWcuaGVpZ2h0ID0gdGhpcy5vcHRpb25zLmhlaWdodCAqIHRoaXMucmF0aW87XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnRhZy53aWR0aCA9IDE5MjA7XG4gICAgICAgICAgICB0aGlzLnRhZy5oZWlnaHQgPSAxMjgwO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jdHggPSB0aGlzLnRhZy5nZXRDb250ZXh0KCcyZCcpIGFzIENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICAgICAgICBpZiAoIXRoaXMuY3R4KVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW52YXMgY29udGV4dCBub3QgZm91bmQnKTtcblxuICAgICAgICB0aGlzLmNhbWVyYSA9IG5ldyBQb2ludCgwLCAwKTtcblxuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXQoKSB7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB0aGlzLnJlc2l6ZVdpbmRvdygpKVxuICAgICAgICB0aGlzLnJlc2l6ZVdpbmRvdygpO1xuICAgICAgICB0aGlzLnRhZy5hZGRFdmVudExpc3RlbmVyKCdjb250ZXh0bWVudScsIGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKVxuICAgICAgICB0aGlzLnRhZy5zdHlsZS5pbWFnZVJlbmRlcmluZyA9IHRoaXMub3B0aW9ucy5yZW5kZXIgPz8gJ2F1dG8nO1xuICAgICAgICB0aGlzLmN0eC5pbWFnZVNtb290aGluZ0VuYWJsZWQgPSB0aGlzLm9wdGlvbnMuc21vb3RoID8/IGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzaXplV2luZG93KCkge1xuICAgICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IHRoaXMucmVhbFNpemU7XG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4pIHtcbiAgICAgICAgICAgIHRoaXMudGFnLndpZHRoID0gdGhpcy5vcHRpb25zLndpZHRoICogdGhpcy5yYXRpbztcbiAgICAgICAgICAgIHRoaXMudGFnLmhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgKiB0aGlzLnJhdGlvO1xuICAgICAgICAgICAgdGhpcy50YWcuc3R5bGUud2lkdGggPSBgJHt3aWR0aH1weGA7XG4gICAgICAgICAgICB0aGlzLnRhZy5zdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xuICAgICAgICAgICAgdGhpcy50YWcuc3R5bGUudG9wID0gYCR7d2luZG93LmlubmVySGVpZ2h0IC8gMiAtIGhlaWdodCAvIDJ9cHhgO1xuICAgICAgICAgICAgdGhpcy50YWcuc3R5bGUubGVmdCA9IGAke3dpbmRvdy5pbm5lcldpZHRoIC8gMiAtIHdpZHRoIC8gMn1weGA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnRhZy5zdHlsZS53aWR0aCA9IGAke3dpbmRvdy5pbm5lcldpZHRofXB4YDtcbiAgICAgICAgICAgIHRoaXMudGFnLnN0eWxlLmhlaWdodCA9IGAke3dpbmRvdy5pbm5lckhlaWdodH1weGA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsb2FkQWxsSW1hZ2VzKCk6IFByb21pc2U8SFRNTEltYWdlRWxlbWVudFtdPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIFByb21pc2UuYWxsKGltYWdlcy5tYXAoaSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFpLmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnTG9hZGluZyBpbWFnZScsIGkuc3JjKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGkub25sb2FkID0gKCkgPT4gcmVzb2x2ZShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGkub25lcnJvciA9ICgpID0+IHJlamVjdChpKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9KS5maWx0ZXIoaSA9PiBpICE9IG51bGwpIGFzIFByb21pc2U8SFRNTEltYWdlRWxlbWVudD5bXSlcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXNvbHZlKHJlcykpXG4gICAgICAgICAgICAuY2F0Y2goaW1nID0+IGltZy5zcmMgPSAnJylcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmVuZGVyTG9vcCgpIHtcbiAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7XG4gICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmJhY2tncm91bmRDb2xvcjtcbiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRoaXMud2lkdGggKiB0aGlzLnJhdGlvLCB0aGlzLmhlaWdodCAqIHRoaXMucmF0aW8pO1xuICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3doaXRlJztcblxuICAgICAgICBjdHguc2F2ZSgpO1xuICAgICAgICBjdHguc2NhbGUodGhpcy5yYXRpbywgdGhpcy5yYXRpbyk7XG4gICAgICAgIGN0eC50cmFuc2xhdGUodGhpcy5jYW1lcmEueCwgdGhpcy5jYW1lcmEueSk7XG5cbiAgICAgICAgY29uc3Qgc29ydGVkSW5zdGFuY2UgPSB0aGlzLmluc3RhbmNlcy5zb3J0KChhLCBiKSA9PiBhLmRlcHRoIC0gYi5kZXB0aCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBpbnN0YW5jZSBvZiBzb3J0ZWRJbnN0YW5jZSkge1xuICAgICAgICAgICAgaW5zdGFuY2UuX3VwZGF0ZShjdHgpO1xuICAgICAgICB9XG5cbiAgICAgICAgY3R4LnJlc3RvcmUoKTtcblxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5yZW5kZXJMb29wLmJpbmQodGhpcykpO1xuICAgIH1cblxuICAgIGFzeW5jIHJ1bkFzeW5jKCkge1xuICAgICAgICBhd2FpdCB0aGlzLmxvYWRBbGxJbWFnZXMoKTtcbiAgICAgICAgdGhpcy5yZW5kZXJMb29wKCk7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMucnVuQXN5bmMoKTtcbiAgICB9XG5cbiAgICBhZGRDaGlsZChpbnN0YW5jZTogSW5zdGFuY2UpIHtcbiAgICAgICAgdGhpcy5pbnN0YW5jZXMucHVzaChpbnN0YW5jZSk7XG5cbiAgICB9XG5cbiAgICBnZXQgd2lkdGgoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhZy53aWR0aCAvIHRoaXMucmF0aW87XG4gICAgfVxuXG4gICAgZ2V0IGhlaWdodCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFnLmhlaWdodCAvIHRoaXMucmF0aW87XG4gICAgfVxuXG4gICAgZ2V0IHJlYWxTaXplKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgd2lkdGg6IHRoaXMucmF0aW8gPyB0aGlzLnRhZy53aWR0aCAvIHRoaXMucmF0aW8gOiB0aGlzLnRhZy53aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5yYXRpbyA/IHRoaXMudGFnLmhlaWdodCAvIHRoaXMucmF0aW8gOiB0aGlzLnRhZy5oZWlnaHRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXQgY2VudGVyKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgeDogdGhpcy53aWR0aCAvIDIsXG4gICAgICAgICAgICB5OiB0aGlzLmhlaWdodCAvIDJcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXQgcmF0aW8oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmF0aW8gPyB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyA6IDE7XG4gICAgfVxufSJdfQ==