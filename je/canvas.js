var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { images } from "./images.js";
import { Point } from "./math.js";
export const getCanvasInstance = () => {
    if (!Canvas.instance) {
        throw new Error('Canvas not initialized');
    }
    return Canvas.instance;
};
export const getInstances = () => getCanvasInstance().instances;
export class Canvas {
    constructor(options) {
        this.instances = [];
        if (!Canvas.instance)
            Canvas.instance = this;
        else
            throw new Error('Canvas instance already exists, use getCanvasInstance() instead of new Canvas().');
        this.options = options || {
            width: 1366,
            height: 768
        };
        this.tag = document.getElementById('canvas');
        if (!this.tag)
            throw new Error('Canvas not found');
        if (!this.options.fullscreen) {
            this.tag.width = this.options.width * this.ratio;
            this.tag.height = this.options.height * this.ratio;
        }
        else {
            this.tag.width = 1920;
            this.tag.height = 1280;
        }
        this.ctx = this.tag.getContext('2d');
        if (!this.ctx)
            throw new Error('Canvas context not found');
        this.camera = new Point(0, 0);
        this.init();
    }
    init() {
        var _a, _b;
        window.addEventListener('resize', () => this.resizeWindow());
        this.resizeWindow();
        this.tag.addEventListener('contextmenu', e => e.preventDefault());
        this.tag.style.imageRendering = (_a = this.options.render) !== null && _a !== void 0 ? _a : 'auto';
        this.ctx.imageSmoothingEnabled = (_b = this.options.smooth) !== null && _b !== void 0 ? _b : false;
    }
    resizeWindow() {
        const { width, height } = this.realSize;
        if (!this.options.fullscreen) {
            this.tag.width = this.options.width * this.ratio;
            this.tag.height = this.options.height * this.ratio;
            this.tag.style.width = `${width}px`;
            this.tag.style.height = `${height}px`;
            this.tag.style.top = `${window.innerHeight / 2 - height / 2}px`;
            this.tag.style.left = `${window.innerWidth / 2 - width / 2}px`;
        }
        else {
            this.tag.style.width = `${window.innerWidth}px`;
            this.tag.style.height = `${window.innerHeight}px`;
        }
    }
    loadAllImages() {
        return new Promise(resolve => {
            Promise.all(images.map(i => {
                if (!i.complete) {
                    return new Promise((resolve, reject) => {
                        console.log('Loading image', i.src);
                        i.onload = () => resolve(i);
                        i.onerror = () => reject(i);
                    });
                }
                return null;
            }).filter(i => i != null))
                .then(res => resolve(res))
                .catch(img => img.src = '');
        });
    }
    renderLoop() {
        const ctx = this.ctx;
        ctx.fillStyle = 'rgb(30, 30, 30)';
        ctx.fillRect(0, 0, this.width * this.ratio, this.height * this.ratio);
        ctx.fillStyle = 'white';
        ctx.save();
        ctx.scale(this.ratio, this.ratio);
        ctx.translate(this.camera.x, this.camera.y);
        const sortedInstance = this.instances.sort((a, b) => a.depth - b.depth);
        for (const instance of sortedInstance) {
            instance._update(ctx);
        }
        ctx.restore();
        requestAnimationFrame(this.renderLoop.bind(this));
    }
    runAsync() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loadAllImages();
            this.renderLoop();
        });
    }
    start() {
        this.runAsync();
    }
    addChild(instance) {
        this.instances.push(instance);
    }
    get width() {
        return this.tag.width / this.ratio;
    }
    get height() {
        return this.tag.height / this.ratio;
    }
    get realSize() {
        return {
            width: this.ratio ? this.tag.width / this.ratio : this.tag.width,
            height: this.ratio ? this.tag.height / this.ratio : this.tag.height
        };
    }
    get center() {
        return {
            x: this.width / 2,
            y: this.height / 2
        };
    }
    get ratio() {
        return this.options.ratio ? window.devicePixelRatio : 1;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLmpzIiwic291cmNlUm9vdCI6ImplLXNyYy8iLCJzb3VyY2VzIjpbImNhbnZhcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFvQmxDLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRTtJQUNsQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtRQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7S0FDN0M7SUFDRCxPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUM7QUFDM0IsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixFQUFFLENBQUMsU0FBUyxDQUFDO0FBRWhFLE1BQU0sT0FBTyxNQUFNO0lBUWYsWUFBWSxPQUF1QjtRQUhuQyxjQUFTLEdBQWUsRUFBRSxDQUFDO1FBSXZCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUTtZQUFFLE1BQU0sQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDOztZQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLGtGQUFrRixDQUFDLENBQUE7UUFFeEcsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLElBQUk7WUFDdEIsS0FBSyxFQUFFLElBQUk7WUFDWCxNQUFNLEVBQUUsR0FBRztTQUNkLENBQUM7UUFDRixJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFzQixDQUFDO1FBRWxFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRztZQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUU7WUFDMUIsSUFBSSxDQUFDLEdBQUcs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UUFBUTtRQUNSLE9BQU87WUFDSCxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLO1lBQ2hFLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU07U0FDdEUsQ0FBQztJQUNOLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDTixPQUFPO1lBQ0gsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQztZQUNqQixDQUFDLEVBQUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDO1NBQ3JCLENBQUM7SUFDTixDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ0wsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5zdGFuY2UgfSBmcm9tIFwiLi9pbnN0YW5jZS5qc1wiO1xyXG5pbXBvcnQgeyBpbWFnZXMgfSBmcm9tIFwiLi9pbWFnZXMuanNcIjtcclxuaW1wb3J0IHsgUG9pbnQgfSBmcm9tIFwiLi9tYXRoLmpzXCI7XHJcblxyXG50eXBlIENhbnZhc090aGVyT3B0aW9ucyA9IFBhcnRpYWw8e1xyXG4gICAgcmVuZGVyOiAncGl4ZWxhdGVkJyB8ICdjcmlzcC1lZGdlcycsXHJcbiAgICBzbW9vdGg6IGJvb2xlYW4sXHJcbiAgICByYXRpbzogYm9vbGVhblxyXG59PjtcclxuXHJcbnR5cGUgQ2FudmFzU2NyZWVuT3B0aW9ucyA9IHtcclxuICAgIHdpZHRoOiBudW1iZXIsXHJcbiAgICBoZWlnaHQ6IG51bWJlcixcclxuICAgIGZ1bGxzY3JlZW4/OiBmYWxzZVxyXG59ICYgQ2FudmFzT3RoZXJPcHRpb25zO1xyXG5cclxudHlwZSBDYW52YXNGdWxsc2NyZWVuT3B0aW9ucyA9IHtcclxuICAgIGZ1bGxzY3JlZW46IHRydWVcclxufSAmIENhbnZhc090aGVyT3B0aW9ucztcclxuXHJcbmV4cG9ydCB0eXBlIENhbnZhc09wdGlvbnMgPSBDYW52YXNTY3JlZW5PcHRpb25zIHwgQ2FudmFzRnVsbHNjcmVlbk9wdGlvbnM7XHJcblxyXG5leHBvcnQgY29uc3QgZ2V0Q2FudmFzSW5zdGFuY2UgPSAoKSA9PiB7XHJcbiAgICBpZiAoIUNhbnZhcy5pbnN0YW5jZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FudmFzIG5vdCBpbml0aWFsaXplZCcpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIENhbnZhcy5pbnN0YW5jZTtcclxufVxyXG5leHBvcnQgY29uc3QgZ2V0SW5zdGFuY2VzID0gKCkgPT4gZ2V0Q2FudmFzSW5zdGFuY2UoKS5pbnN0YW5jZXM7XHJcblxyXG5leHBvcnQgY2xhc3MgQ2FudmFzIHtcclxuICAgIHN0YXRpYyBpbnN0YW5jZTogQ2FudmFzIHwgbnVsbDtcclxuICAgIG9wdGlvbnM6IENhbnZhc09wdGlvbnM7XHJcbiAgICB0YWc6IEhUTUxDYW52YXNFbGVtZW50O1xyXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XHJcbiAgICBpbnN0YW5jZXM6IEluc3RhbmNlW10gPSBbXTtcclxuICAgIGNhbWVyYTogUG9pbnQ7XHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0aW9ucz86IENhbnZhc09wdGlvbnMpIHtcclxuICAgICAgICBpZiAoIUNhbnZhcy5pbnN0YW5jZSkgQ2FudmFzLmluc3RhbmNlID0gdGhpcztcclxuICAgICAgICBlbHNlIHRocm93IG5ldyBFcnJvcignQ2FudmFzIGluc3RhbmNlIGFscmVhZHkgZXhpc3RzLCB1c2UgZ2V0Q2FudmFzSW5zdGFuY2UoKSBpbnN0ZWFkIG9mIG5ldyBDYW52YXMoKS4nKVxyXG5cclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHtcclxuICAgICAgICAgICAgd2lkdGg6IDEzNjYsXHJcbiAgICAgICAgICAgIGhlaWdodDogNzY4XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnRhZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYW52YXMnKSBhcyBIVE1MQ2FudmFzRWxlbWVudDtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLnRhZylcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW52YXMgbm90IGZvdW5kJyk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4pIHtcclxuICAgICAgICAgICAgdGhpcy50YWcud2lkdGggPSB0aGlzLm9wdGlvbnMud2lkdGggKiB0aGlzLnJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLnRhZy5oZWlnaHQgPSB0aGlzLm9wdGlvbnMuaGVpZ2h0ICogdGhpcy5yYXRpbztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnRhZy53aWR0aCA9IDE5MjA7XHJcbiAgICAgICAgICAgIHRoaXMudGFnLmhlaWdodCA9IDEyODA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmN0eCA9IHRoaXMudGFnLmdldENvbnRleHQoJzJkJykgYXMgQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY3R4KVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhbnZhcyBjb250ZXh0IG5vdCBmb3VuZCcpO1xyXG5cclxuICAgICAgICB0aGlzLmNhbWVyYSA9IG5ldyBQb2ludCgwLCAwKTtcclxuXHJcbiAgICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0KCkge1xyXG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB0aGlzLnJlc2l6ZVdpbmRvdygpKVxyXG4gICAgICAgIHRoaXMucmVzaXplV2luZG93KCk7XHJcbiAgICAgICAgdGhpcy50YWcuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCBlID0+IGUucHJldmVudERlZmF1bHQoKSlcclxuICAgICAgICB0aGlzLnRhZy5zdHlsZS5pbWFnZVJlbmRlcmluZyA9IHRoaXMub3B0aW9ucy5yZW5kZXIgPz8gJ2F1dG8nO1xyXG4gICAgICAgIHRoaXMuY3R4LmltYWdlU21vb3RoaW5nRW5hYmxlZCA9IHRoaXMub3B0aW9ucy5zbW9vdGggPz8gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNpemVXaW5kb3coKSB7XHJcbiAgICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLnJlYWxTaXplO1xyXG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4pIHtcclxuICAgICAgICAgICAgdGhpcy50YWcud2lkdGggPSB0aGlzLm9wdGlvbnMud2lkdGggKiB0aGlzLnJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLnRhZy5oZWlnaHQgPSB0aGlzLm9wdGlvbnMuaGVpZ2h0ICogdGhpcy5yYXRpbztcclxuICAgICAgICAgICAgdGhpcy50YWcuc3R5bGUud2lkdGggPSBgJHt3aWR0aH1weGA7XHJcbiAgICAgICAgICAgIHRoaXMudGFnLnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XHJcbiAgICAgICAgICAgIHRoaXMudGFnLnN0eWxlLnRvcCA9IGAke3dpbmRvdy5pbm5lckhlaWdodCAvIDIgLSBoZWlnaHQgLyAyfXB4YDtcclxuICAgICAgICAgICAgdGhpcy50YWcuc3R5bGUubGVmdCA9IGAke3dpbmRvdy5pbm5lcldpZHRoIC8gMiAtIHdpZHRoIC8gMn1weGA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy50YWcuc3R5bGUud2lkdGggPSBgJHt3aW5kb3cuaW5uZXJXaWR0aH1weGA7XHJcbiAgICAgICAgICAgIHRoaXMudGFnLnN0eWxlLmhlaWdodCA9IGAke3dpbmRvdy5pbm5lckhlaWdodH1weGA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxvYWRBbGxJbWFnZXMoKTogUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50W10+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XHJcbiAgICAgICAgICAgIFByb21pc2UuYWxsKGltYWdlcy5tYXAoaSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWkuY29tcGxldGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnTG9hZGluZyBpbWFnZScsIGkuc3JjKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaS5vbmxvYWQgPSAoKSA9PiByZXNvbHZlKGkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpLm9uZXJyb3IgPSAoKSA9PiByZWplY3QoaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9KS5maWx0ZXIoaSA9PiBpICE9IG51bGwpIGFzIFByb21pc2U8SFRNTEltYWdlRWxlbWVudD5bXSlcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlc29sdmUocmVzKSlcclxuICAgICAgICAgICAgLmNhdGNoKGltZyA9PiBpbWcuc3JjID0gJycpXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyTG9vcCgpIHtcclxuICAgICAgICBjb25zdCBjdHggPSB0aGlzLmN0eDtcclxuICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYigzMCwgMzAsIDMwKSc7XHJcbiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRoaXMud2lkdGggKiB0aGlzLnJhdGlvLCB0aGlzLmhlaWdodCAqIHRoaXMucmF0aW8pO1xyXG4gICAgICAgIGN0eC5maWxsU3R5bGUgPSAnd2hpdGUnO1xyXG5cclxuICAgICAgICBjdHguc2F2ZSgpO1xyXG4gICAgICAgIGN0eC5zY2FsZSh0aGlzLnJhdGlvLCB0aGlzLnJhdGlvKTtcclxuICAgICAgICBjdHgudHJhbnNsYXRlKHRoaXMuY2FtZXJhLngsIHRoaXMuY2FtZXJhLnkpO1xyXG5cclxuICAgICAgICBjb25zdCBzb3J0ZWRJbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2VzLnNvcnQoKGEsIGIpID0+IGEuZGVwdGggLSBiLmRlcHRoKTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBpbnN0YW5jZSBvZiBzb3J0ZWRJbnN0YW5jZSkge1xyXG4gICAgICAgICAgICBpbnN0YW5jZS5fdXBkYXRlKGN0eCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjdHgucmVzdG9yZSgpO1xyXG5cclxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5yZW5kZXJMb29wLmJpbmQodGhpcykpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHJ1bkFzeW5jKCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMubG9hZEFsbEltYWdlcygpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyTG9vcCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0KCkge1xyXG4gICAgICAgIHRoaXMucnVuQXN5bmMoKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRDaGlsZChpbnN0YW5jZTogSW5zdGFuY2UpIHtcclxuICAgICAgICB0aGlzLmluc3RhbmNlcy5wdXNoKGluc3RhbmNlKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHdpZHRoKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRhZy53aWR0aCAvIHRoaXMucmF0aW87XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50YWcuaGVpZ2h0IC8gdGhpcy5yYXRpbztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcmVhbFNpemUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMucmF0aW8gPyB0aGlzLnRhZy53aWR0aCAvIHRoaXMucmF0aW8gOiB0aGlzLnRhZy53aWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLnJhdGlvID8gdGhpcy50YWcuaGVpZ2h0IC8gdGhpcy5yYXRpbyA6IHRoaXMudGFnLmhlaWdodFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGNlbnRlcigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB4OiB0aGlzLndpZHRoIC8gMixcclxuICAgICAgICAgICAgeTogdGhpcy5oZWlnaHQgLyAyXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcmF0aW8oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5yYXRpbyA/IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIDogMTtcclxuICAgIH1cclxufSJdfQ==