{"version":3,"file":"instance.js","sourceRoot":"je-src/","sources":["instance.ts"],"names":[],"mappings":"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","sourcesContent":["import { Point, Rect } from \"./math.js\";\nimport { Canvas, getCanvasInstance } from \"./canvas.js\";\nimport { AnyColor, Color } from \"./colors.js\";\nimport { ChildrenArray } from \"./childrenArray.js\";\n\nlet lastInstanceId = 0;\nlet canvasInstance: Canvas | null = null;\n\nexport interface Rectable {\n    get rect(): Rect;\n}\n\nexport abstract class Instance extends ChildrenArray<Instance> {\n    private firstUpdate = false;\n    protected dontTranslate = false;\n    protected drawChildBottom = true;\n    index: number;\n    depth = 0;\n    x = 0;\n    y = 0;\n    clipStroke = false;\n\n    constructor() {\n        super();\n        this.index = ++lastInstanceId;\n        this.onCreate();\n    }\n\n    onCreate() {}\n    onBegin() {}\n    onDestroy() {}\n\n    onUpdate() {}\n\n    onDraw() {}\n\n    _update(ctx: CanvasRenderingContext2D) {\n        const updateChildren = () => this.children.sort((a, b) => a.depth - b.depth).forEach(child => child._update(ctx));\n        ctx.save();\n        this.onUpdate();\n        if (!this.dontTranslate) ctx.translate(this.x, this.y);\n        if (!this.firstUpdate) {\n            this.onBegin();\n            this.firstUpdate = true;\n        }\n        if (this.drawChildBottom) updateChildren();\n        this.onDraw();\n        if (!this.drawChildBottom) updateChildren();\n        ctx.restore();\n    }\n\n    translate(x: number, y: number) {\n        this.ctx.translate(x, y);\n    }\n\n    save() {\n        this.ctx.save();\n    }\n\n    restore() {\n        this.ctx.restore();\n    }\n\n    get lineWidth() {\n        return this.ctx.lineWidth;\n    }\n\n    set lineWidth(w: number) {\n        this.ctx.lineWidth = w;\n    }\n\n    set fontAlign(align: CanvasTextAlign) {\n        this.ctx.textAlign = align;\n    }\n\n    private setColor(prop: 'fillStyle' | 'strokeStyle', c: AnyColor) {\n        this.ctx[prop] = typeof c == 'string' ? c : Array.isArray(c) ? Color.from(c[0], c[1], c[2], c[3]) : Color.convert(c);\n    }\n\n    set fillColor(c: AnyColor) {\n        this.setColor('fillStyle', c);\n    }\n\n    set strokeColor(c: AnyColor) {\n        this.setColor('strokeStyle', c);\n    }\n\n    set fontBaseline(baseline: CanvasTextBaseline) {\n        this.ctx.textBaseline = baseline;\n    }\n\n    set font(font: string) {\n        this.ctx.font = font;\n    }\n\n    rectangle(x: number, y: number, width: number, height: number) {\n        this.ctx.beginPath();\n        this.ctx.rect(x - width / 2, y - height / 2, width, height);\n        this.ctx.closePath();\n    }\n\n    circle(x: number, y: number, radius: number) {\n        this.ctx.beginPath();\n        this.ctx.arc(x, y, radius, 0, 2 * Math.PI);\n        this.ctx.closePath();\n    }\n\n    path(vertexes: Point[], closePath = true) {\n        this.ctx.beginPath();\n        this.ctx.moveTo(vertexes[0].x, vertexes[0].y);\n        for (let i = 1; i < vertexes.length; i++) {\n            this.ctx.lineTo(vertexes[i].x, vertexes[i].y);\n        }\n        if (closePath) this.ctx.closePath();\n    }\n\n    polygon(angles: number, { scale, rotation }: Partial<{ scale: number, rotation: number }>) {\n        scale ??= 1;\n        rotation ??= 0;\n        const theta = 2 * Math.PI / angles;\n        this.path(\n            Array.from({ length: angles }, (_, i) => new Point(\n                Math.cos(i * theta + (rotation as number) / 180 * Math.PI) * (scale as number),\n                Math.sin(i * theta + (rotation as number) / 180 * Math.PI) * (scale as number)\n            ))\n        );\n    }\n\n    fill() {\n        this.ctx.fill();\n    }\n\n    stroke() {\n        if (this.clipStroke) {\n            this.save();\n            {\n                this.lineWidth *= 2;\n                this.ctx.clip();\n                this.ctx.stroke();\n                this.lineWidth /= 2;\n            }\n            this.restore();\n        } else {\n            this.ctx.stroke();\n        }\n    }\n\n    fillText(x: number, y: number, ...text: any[]) {\n        this.ctx.fillText(text.join(' '), x, y);\n    }\n\n    strokeText(x: number, y: number, ...text: any[]) {\n        this.ctx.strokeText(text.join(' '), x, y);\n    }\n\n    drawImage(image: HTMLImageElement, x: number, y: number, width: number, height: number) {\n        this.ctx.drawImage(image, x - width / 2,  y - height / 2, width, height);\n    }\n\n    /**\n     * @param value Alpha value from 0 to 1 (decimal).\n     */\n    set alpha(value: number) {\n        this.ctx.globalAlpha = value;\n    }\n\n    measureText(...text: any[]) {\n        return this.ctx.measureText(text.join(' '));\n    }\n\n    destroy(cleanup = true) {\n        if (cleanup) this.children.forEach(child => child.destroy());\n        this.onDestroy();\n        this.canvas.instances.splice(this.canvas.instances.indexOf(this), 1);\n    }\n\n    getRect(width: number, height: number) {\n        const { pos } = this;\n        return new Rect(pos.x - width / 2, pos.y - height / 2, width, height);\n    }\n\n    isClassOf(...instancesClasses: FunctionConstructor[]) {\n        for (const cls of instancesClasses) {\n            if (this instanceof cls)\n                return true;\n        }\n        return false;\n    }\n\n    addToMain() {\n        this.canvas.add(this);\n    }\n\n    get pos() {\n        const parent = this.parent ? this.parent.pos : new Point(0, 0);\n        return new Point(this.x + parent.x, this.y + parent.y);\n    }\n\n    set pos(p: Point) {\n        this.x = p.x;\n        this.y = p.y;\n    }\n\n    get canvas() {\n        if (!canvasInstance) canvasInstance = getCanvasInstance();\n        return canvasInstance;\n    }\n\n    get ctx() {\n        return this.canvas.ctx;\n    }\n}"]}