import { Instance } from "./instance.js";
export const images = [];
export const loadImage = (src) => {
    const image = images.find(i => i.id == src);
    if (image)
        return image;
    const img = new Image();
    img.src = src;
    img.id = src;
    images.push(img);
    return img;
};
export class ImageInstance extends Instance {
    constructor(imageUrl) {
        super();
        this.scaleX = 1;
        this.scaleY = 1;
        this.image = loadImage(imageUrl);
    }
    onDraw() {
        this.drawSelf();
    }
    drawSelf() {
        if (!this.image.src)
            return;
        this.drawImage(this.image, 0, 0, this.image.width * this.scaleX, this.image.height * this.scaleY);
    }
    get width() {
        return this.image.width * this.scaleX;
    }
    set width(w) {
        this.scaleX = w / this.width;
    }
    get height() {
        return this.image.height * this.scaleY;
    }
    set height(h) {
        this.scaleY = h / this.height;
    }
    get center() {
        return this.rect.center;
    }
    set center(p) {
        this.x = p.x - this.width / 2;
        this.y = p.y - this.height / 2;
    }
    get rect() {
        return this.getRect(this.width, this.height);
    }
}
// TODO: fix copy-paste
export class Image9Instance extends Instance {
    constructor(imageUrl, pad) {
        super();
        this.pad = pad;
        this.scaleX = 1;
        this.scaleY = 1;
        this.image = loadImage(imageUrl);
        this.imageSlices = [];
        new Promise(resolve => {
            this.image.addEventListener('load', resolve);
        }).then(() => {
            // define the 9 parts as [x, y, w, h]
            this.imageSlices = [
                [0, 0],
                [pad, 0],
                [pad * 2, 0],
                [0, pad],
                [pad, pad],
                [pad * 2, pad],
                [0, pad * 2],
                [pad, pad * 2],
                [pad * 2, pad * 2]
            ].map(x => [x[0], x[1], pad, pad]);
        });
    }
    onDraw() {
        this.drawSelf();
    }
    drawSelf() {
        if (!this.image.src)
            return;
        const { pad, imageSlices, image, ctx } = this;
        ctx.translate(-this.width / 2, -this.height / 2);
        const size = 0.5;
        let width = this.width + size, height = this.height + size, x = size, y = size;
        ctx.drawImage(image, ...imageSlices[0], x, y, pad, pad);
        ctx.drawImage(image, ...imageSlices[2], width - pad - x, y, pad, pad);
        ctx.drawImage(image, ...imageSlices[6], x, height - pad - y, pad, pad);
        ctx.drawImage(image, ...imageSlices[8], width - pad - x, height - pad - y, pad, pad);
        ctx.drawImage(image, ...imageSlices[1], pad, y, width - 2 * pad, pad);
        ctx.drawImage(image, ...imageSlices[7], pad, height - pad - y, width - 2 * pad, pad);
        ctx.drawImage(image, ...imageSlices[3], x, pad, pad, height - 2 * pad);
        ctx.drawImage(image, ...imageSlices[5], width - pad - x, pad, pad, height - 2 * pad);
        ctx.drawImage(image, ...imageSlices[4], pad, pad, width - 2 * pad, height - 2 * pad);
    }
    get rect() {
        return this.getRect(this.width, this.height);
    }
    get width() {
        return this.image.width * this.scaleX;
    }
    set width(w) {
        this.scaleX = w / this.width;
    }
    get height() {
        return this.image.height * this.scaleY;
    }
    set height(h) {
        this.scaleY = h / this.height;
    }
    get center() {
        return this.rect.center;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2VzLmpzIiwic291cmNlUm9vdCI6ImplLXNyYy8iLCJzb3VyY2VzIjpbImltYWdlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3pDLE1BQU0sQ0FBQyxNQUFNLE1BQU0sR0FBdUIsRUFBRSxDQUFDO0FBRTdDLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFO0lBQ3JDLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxDQUFDO0lBQzVDLElBQUksS0FBSztRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQ3hCLE1BQU0sR0FBRyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7SUFDeEIsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDZCxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQztJQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDLENBQUE7QUFFRCxNQUFNLE9BQU8sYUFBYyxTQUFRLFFBQVE7SUFLdkMsWUFBWSxRQUFnQjtRQUN4QixLQUFLLEVBQUUsQ0FBQztRQUpKLFdBQU0sR0FBRyxDQUFDLENBQUM7UUFDWCxXQUFNLEdBQUcsQ0FBQyxDQUFDO1FBSWYsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELE1BQU07UUFDRixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHO1lBQ2YsT0FBTztRQUNYLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUs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QUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUVwRixHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEtBQUssR0FBRyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQ3JFLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsRUFBRSxLQUFLLEdBQUcsQ0FBQyxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUNwRixHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFBO1FBQ3RFLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtRQUVwRixHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssR0FBRyxDQUFDLEdBQUcsR0FBRyxFQUFFLE1BQU0sR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUE7SUFDeEYsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ0wsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQzFDLENBQUM7SUFFRCxJQUFJLEtBQUssQ0FBQyxDQUFDO1FBQ1AsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNqQyxDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQzNDLENBQUM7SUFFRCxJQUFJLE1BQU0sQ0FBQyxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUM1QixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnN0YW5jZSB9IGZyb20gXCIuL2luc3RhbmNlLmpzXCI7XHJcbmltcG9ydCB7IFBvaW50IH0gZnJvbSBcIi4vbWF0aC5qc1wiO1xyXG5cclxuZXhwb3J0IGNvbnN0IGltYWdlczogSFRNTEltYWdlRWxlbWVudFtdID0gW107XHJcblxyXG5leHBvcnQgY29uc3QgbG9hZEltYWdlID0gKHNyYzogc3RyaW5nKSA9PiB7XHJcbiAgICBjb25zdCBpbWFnZSA9IGltYWdlcy5maW5kKGkgPT4gaS5pZCA9PSBzcmMpO1xyXG4gICAgaWYgKGltYWdlKSByZXR1cm4gaW1hZ2U7XHJcbiAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcclxuICAgIGltZy5zcmMgPSBzcmM7XHJcbiAgICBpbWcuaWQgPSBzcmM7XHJcbiAgICBpbWFnZXMucHVzaChpbWcpO1xyXG4gICAgcmV0dXJuIGltZztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEltYWdlSW5zdGFuY2UgZXh0ZW5kcyBJbnN0YW5jZSB7XHJcbiAgICBwcm90ZWN0ZWQgaW1hZ2U6IEhUTUxJbWFnZUVsZW1lbnQ7XHJcbiAgICBwcml2YXRlIHNjYWxlWCA9IDE7XHJcbiAgICBwcml2YXRlIHNjYWxlWSA9IDE7XHJcblxyXG4gICAgY29uc3RydWN0b3IoaW1hZ2VVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5pbWFnZSA9IGxvYWRJbWFnZShpbWFnZVVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25EcmF3KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZHJhd1NlbGYoKTtcclxuICAgIH1cclxuXHJcbiAgICBkcmF3U2VsZigpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaW1hZ2Uuc3JjKVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgdGhpcy5kcmF3SW1hZ2UodGhpcy5pbWFnZSwgMCwgMCwgdGhpcy5pbWFnZS53aWR0aCAqIHRoaXMuc2NhbGVYLCB0aGlzLmltYWdlLmhlaWdodCAqIHRoaXMuc2NhbGVZKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgd2lkdGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1hZ2Uud2lkdGggKiB0aGlzLnNjYWxlWDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgd2lkdGgodykge1xyXG4gICAgICAgIHRoaXMuc2NhbGVYID0gdyAvIHRoaXMud2lkdGg7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbWFnZS5oZWlnaHQgKiB0aGlzLnNjYWxlWTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgaGVpZ2h0KGgpIHtcclxuICAgICAgICB0aGlzLnNjYWxlWSA9IGggLyB0aGlzLmhlaWdodDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY2VudGVyKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlY3QuY2VudGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBjZW50ZXIocDogUG9pbnQpIHtcclxuICAgICAgICB0aGlzLnggPSBwLnggLSB0aGlzLndpZHRoIC8gMjtcclxuICAgICAgICB0aGlzLnkgPSBwLnkgLSB0aGlzLmhlaWdodCAvIDI7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHJlY3QoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVjdCh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIFRPRE86IGZpeCBjb3B5LXBhc3RlXHJcbmV4cG9ydCBjbGFzcyBJbWFnZTlJbnN0YW5jZSBleHRlbmRzIEluc3RhbmNlIHtcclxuICAgIHByb3RlY3RlZCBpbWFnZTogSFRNTEltYWdlRWxlbWVudDtcclxuICAgIHByaXZhdGUgaW1hZ2VTbGljZXM6ICBbbnVtYmVyLCBudW1iZXIsIG51bWJlciwgbnVtYmVyXVtdO1xyXG4gICAgcHJpdmF0ZSBzY2FsZVggPSAxO1xyXG4gICAgcHJpdmF0ZSBzY2FsZVkgPSAxO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGltYWdlVXJsOiBzdHJpbmcsIHB1YmxpYyBwYWQ6IG51bWJlcikge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5pbWFnZSA9IGxvYWRJbWFnZShpbWFnZVVybCk7XHJcbiAgICAgICAgdGhpcy5pbWFnZVNsaWNlcyA9IFtdO1xyXG4gICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmltYWdlLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCByZXNvbHZlKTtcclxuICAgICAgICB9KS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgLy8gZGVmaW5lIHRoZSA5IHBhcnRzIGFzIFt4LCB5LCB3LCBoXVxyXG4gICAgICAgICAgICB0aGlzLmltYWdlU2xpY2VzID0gW1xyXG4gICAgICAgICAgICAgICAgWzAsICAgICAgIDAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgW3BhZCwgICAgIDAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgW3BhZCAqIDIsIDAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgWzAsICAgICAgIHBhZCAgICBdLFxyXG4gICAgICAgICAgICAgICAgW3BhZCwgICAgIHBhZCAgICBdLFxyXG4gICAgICAgICAgICAgICAgW3BhZCAqIDIsIHBhZCAgICBdLFxyXG4gICAgICAgICAgICAgICAgWzAsICAgICAgIHBhZCAqIDJdLFxyXG4gICAgICAgICAgICAgICAgW3BhZCwgICAgIHBhZCAqIDJdLFxyXG4gICAgICAgICAgICAgICAgW3BhZCAqIDIsIHBhZCAqIDJdXHJcbiAgICAgICAgICAgIF0ubWFwKHggPT4gW3hbMF0sIHhbMV0sIHBhZCwgcGFkXSk7XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBvbkRyYXcoKSB7XHJcbiAgICAgICAgdGhpcy5kcmF3U2VsZigpO1xyXG4gICAgfVxyXG5cclxuICAgIGRyYXdTZWxmKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5pbWFnZS5zcmMpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICBjb25zdCB7IHBhZCwgaW1hZ2VTbGljZXMsIGltYWdlLCBjdHggfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIGN0eC50cmFuc2xhdGUoLXRoaXMud2lkdGggLyAyLCAtdGhpcy5oZWlnaHQgLyAyKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2l6ZSA9IDAuNTtcclxuXHJcbiAgICAgICAgbGV0IHdpZHRoID0gdGhpcy53aWR0aCArIHNpemUsXHJcbiAgICAgICAgICAgIGhlaWdodCA9IHRoaXMuaGVpZ2h0ICsgc2l6ZSxcclxuICAgICAgICAgICAgeCA9IHNpemUsXHJcbiAgICAgICAgICAgIHkgPSBzaXplO1xyXG5cclxuICAgICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCAuLi5pbWFnZVNsaWNlc1swXSwgeCwgeSwgcGFkLCBwYWQpO1xyXG4gICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1hZ2UsIC4uLmltYWdlU2xpY2VzWzJdLCB3aWR0aCAtIHBhZCAtIHgsIHksIHBhZCwgcGFkKVxyXG4gICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1hZ2UsIC4uLmltYWdlU2xpY2VzWzZdLCB4LCBoZWlnaHQgLSBwYWQgLSB5LCBwYWQsIHBhZClcclxuICAgICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCAuLi5pbWFnZVNsaWNlc1s4XSwgd2lkdGggLSBwYWQgLSB4LCBoZWlnaHQgLSBwYWQgLSB5LCBwYWQsIHBhZClcclxuXHJcbiAgICAgICAgY3R4LmRyYXdJbWFnZShpbWFnZSwgLi4uaW1hZ2VTbGljZXNbMV0sIHBhZCwgeSwgd2lkdGggLSAyICogcGFkLCBwYWQpXHJcbiAgICAgICAgY3R4LmRyYXdJbWFnZShpbWFnZSwgLi4uaW1hZ2VTbGljZXNbN10sIHBhZCwgaGVpZ2h0IC0gcGFkIC0geSwgd2lkdGggLSAyICogcGFkLCBwYWQpXHJcbiAgICAgICAgY3R4LmRyYXdJbWFnZShpbWFnZSwgLi4uaW1hZ2VTbGljZXNbM10sIHgsIHBhZCwgcGFkLCBoZWlnaHQgLSAyICogcGFkKVxyXG4gICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1hZ2UsIC4uLmltYWdlU2xpY2VzWzVdLCB3aWR0aCAtIHBhZCAtIHgsIHBhZCwgcGFkLCBoZWlnaHQgLSAyICogcGFkKVxyXG5cclxuICAgICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCAuLi5pbWFnZVNsaWNlc1s0XSwgcGFkLCBwYWQsIHdpZHRoIC0gMiAqIHBhZCwgaGVpZ2h0IC0gMiAqIHBhZClcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcmVjdCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRSZWN0KHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgd2lkdGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1hZ2Uud2lkdGggKiB0aGlzLnNjYWxlWDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgd2lkdGgodykge1xyXG4gICAgICAgIHRoaXMuc2NhbGVYID0gdyAvIHRoaXMud2lkdGg7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbWFnZS5oZWlnaHQgKiB0aGlzLnNjYWxlWTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgaGVpZ2h0KGgpIHtcclxuICAgICAgICB0aGlzLnNjYWxlWSA9IGggLyB0aGlzLmhlaWdodDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY2VudGVyKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlY3QuY2VudGVyO1xyXG4gICAgfVxyXG59Il19