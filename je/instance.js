import { Point, Rect } from "./math.js";
import { getCanvasInstance } from "./canvas.js";
import { createColor, toCanvasColor } from "./colors.js";
import { ChildrenArray } from "./childrenArray.js";
let _instanceId = 0;
export class Instance extends ChildrenArray {
    constructor() {
        super();
        this._canvas = null;
        this.firstUpdate = false;
        this.clipStroke = false;
        this._dontTranslate = false;
        this.drawChildBottom = true;
        this.depth = 0;
        this.rotation = 0;
        this.x = 0;
        this.y = 0;
        this.index = ++_instanceId;
        this.onCreate();
    }
    onCreate() { }
    onBegin() { }
    onDestroy() { }
    onUpdate() { }
    onDraw() { }
    _update(ctx) {
        ctx.save();
        this.onUpdate();
        if (!this._dontTranslate)
            ctx.translate(this.x, this.y);
        if (!this.firstUpdate) {
            this.onBegin();
            this.firstUpdate = true;
        }
        if (this.drawChildBottom)
            this.children.sort((a, b) => a.depth - b.depth).forEach(child => child._update(ctx));
        this.onDraw();
        if (!this.drawChildBottom)
            this.children.sort((a, b) => a.depth - b.depth).forEach(child => child._update(ctx));
        ctx.restore();
    }
    setFontAlign(align) {
        this.ctx.textAlign = align;
    }
    setFillColor(color) {
        this.ctx.fillStyle = color;
    }
    setStrokeColor(color) {
        this.ctx.strokeStyle = color;
    }
    setColor(arg1, arg2, arg3, arg4) {
        if (typeof arg1 === 'object')
            this.setColor(toCanvasColor(arg1));
        else if (typeof arg1 === 'string') {
            this.setFillColor(arg1);
            this.setStrokeColor(arg1);
        }
        else
            this.setColor(createColor(arg1, arg2, arg3, arg4));
    }
    setFontBaseline(baseline) {
        this.ctx.textBaseline = baseline;
    }
    setFont(font) {
        this.ctx.font = font;
    }
    fillRect(x, y, width, height) {
        this.ctx.fillRect(x - width / 2, y - height / 2, width, height);
    }
    fillCircle(x, y, radius) {
        this.ctx.beginPath();
        this.ctx.arc(x, y, radius, 0, 2 * Math.PI);
        this.ctx.fill();
    }
    stroke() {
        if (this.clipStroke) {
            this.ctx.save();
            this.ctx.lineWidth *= 2;
            this.ctx.clip();
            this.ctx.stroke();
            this.ctx.lineWidth /= 2;
            this.ctx.restore();
        }
        else {
            this.ctx.stroke();
        }
    }
    strokeRect(x, y, width, height) {
        this.ctx.beginPath();
        this.ctx.rect(x - width / 2, y - height / 2, width, height);
        this.stroke();
    }
    strokeCircle(x, y, radius) {
        this.ctx.beginPath();
        this.ctx.arc(x, y, radius, 0, 2 * Math.PI);
        this.stroke();
    }
    setClipStroke(clipStroke) {
        this.clipStroke = clipStroke;
    }
    drawText(x, y, ...text) {
        this.ctx.fillText(text.join(' '), x, y);
    }
    drawImage(image, x, y, width, height) {
        this.ctx.drawImage(image, x - width / 2, y - height / 2, width, height);
    }
    setAlpha(value = 1) {
        this.ctx.globalAlpha = value;
    }
    measureText(...text) {
        return this.ctx.measureText(text.join(' '));
    }
    destroy(cleanup = true) {
        if (cleanup)
            this.children.forEach(child => child.destroy());
        this.onDestroy();
        this.canvas.instances.splice(this.canvas.instances.indexOf(this), 1);
    }
    getRect(width, height) {
        const { pos } = this;
        return new Rect(pos.x - width / 2, pos.y - height / 2, width, height);
    }
    isClassOf(...instancesClasses) {
        for (const cls of instancesClasses) {
            if (this instanceof cls)
                return true;
        }
        return false;
    }
    addToCanvas() {
        this.canvas.addChild(this);
    }
    get pos() {
        const parent = this.parent ? this.parent.pos : new Point(0, 0);
        return new Point(this.x + parent.x, this.y + parent.y);
    }
    set pos(p) {
        this.x = p.x;
        this.y = p.y;
    }
    get canvas() {
        if (!this._canvas)
            this._canvas = getCanvasInstance();
        return this._canvas;
    }
    get ctx() {
        return this.canvas.ctx;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFuY2UuanMiLCJzb3VyY2VSb290IjoiamUtc3JjLyIsInNvdXJjZXMiOlsiaW5zdGFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDeEMsT0FBTyxFQUFVLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hELE9BQU8sRUFBUyxXQUFXLEVBQUUsYUFBYSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVuRCxJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFFcEIsTUFBTSxPQUFnQixRQUFTLFNBQVEsYUFBdUI7SUFZMUQ7UUFDSSxLQUFLLEVBQUUsQ0FBQztRQVpKLFlBQU8sR0FBa0IsSUFBSSxDQUFDO1FBQzlCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFDakIsbUJBQWMsR0FBRyxLQUFLLENBQUM7UUFDdkIsb0JBQWUsR0FBRyxJQUFJLENBQUM7UUFFakMsVUFBSyxHQUFHLENBQUMsQ0FBQztRQUNWLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFDYixNQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ04sTUFBQyxHQUFHLENBQUMsQ0FBQztRQUlGLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxXQUFXLENBQUM7UUFDM0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxRQUFRLEtBQUksQ0FBQztJQUNiLE9BQU8sS0FBSSxDQUFDO0lBQ1osU0FBUyxLQUFJLENBQUM7SUFFZCxRQUFRLEtBQUksQ0FBQztJQUViLE1BQU0sS0FBSSxDQUFDO0lBRVgsT0FBTyxDQUFDLEdBQTZCO1FBQ2pDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNYLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWM7WUFBRSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ25CLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1NBQzNCO1FBQ0QsSUFBSSxJQUFJLENBQUMsZUFBZTtZQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQy9HLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZTtZQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hILEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQXNCO1FBQy9CLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztJQUMvQixDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQWE7UUFDdEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO0lBQy9CLENBQUM7SUFFRCxjQUFjLENBQUMsS0FBYTtRQUN4QixJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFDakMsQ0FBQztJQUtELFFBQVEsQ0FBQyxJQUE2QixFQUFFLElBQWEsRUFBRSxJQUFhLEVBQUUsSUFBYTtRQUMvRSxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVE7WUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQzVELElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQy9CLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3Qjs7WUFDSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBYyxFQUFFLElBQWMsRUFBRSxJQUFjLENBQUMsQ0FBQyxDQUFDO0lBQzFGLENBQUM7SUFFRCxlQUFlLENBQUMsUUFBNEI7UUFDeEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxPQUFPLENBQUMsSUFBWTtRQUNoQixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDekIsQ0FBQztJQUVELFFBQVEsQ0FBQyxDQUFTLEVBQUUsQ0FBUyxFQUFFLEtBQWEsRUFBRSxNQUFjO1FBQ3hELElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRUQsVUFBVSxDQUFDLENBQVMsRUFBRSxDQUFTLEVBQUUsTUFBYztRQUMzQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVPLE1BQU07UUFDVixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDakIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2xCLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3RCO2FBQU07WUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQUVELFVBQVUsQ0FBQyxDQUFTLEVBQUUsQ0FBUyxFQUFFLEtBQWEsRUFBRSxNQUFjO1FBQzFELElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQsWUFBWSxDQUFDLENBQVMsRUFBRSxDQUFTLEVBQUUsTUFBYztRQUM3QyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQsYUFBYSxDQUFDLFVBQW1CO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQ2pDLENBQUM7SUFFRCxRQUFRLENBQUMsQ0FBUyxFQUFFLENBQVMsRUFBRSxHQUFHLElBQVc7UUFDekMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUF1QixFQUFFLENBQVMsRUFBRSxDQUFTLEVBQUUsS0FBYSxFQUFFLE1BQWM7UUFDbEYsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxFQUFHLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBRUQsUUFBUSxDQUFDLFFBQWdCLENBQUM7UUFDdEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxXQUFXLENBQUMsR0FBRyxJQUFXO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxPQUFPLENBQUMsT0FBTyxHQUFHLElBQUk7UUFDbEIsSUFBSSxPQUFPO1lBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRUQsT0FBTyxDQUFDLEtBQWEsRUFBRSxNQUFjO1FBQ2pDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDckIsT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsU0FBUyxDQUFDLEdBQUcsZ0JBQXVDO1FBQ2hELEtBQUssTUFBTSxHQUFHLElBQUksZ0JBQWdCLEVBQUU7WUFDaEMsSUFBSSxJQUFJLFlBQVksR0FBRztnQkFDbkIsT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFJLEdBQUc7UUFDSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9ELE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxJQUFJLEdBQUcsQ0FBQyxDQUFRO1FBQ1osSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2IsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87WUFBRSxJQUFJLENBQUMsT0FBTyxHQUFHLGlCQUFpQixFQUFFLENBQUM7UUFDdEQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLEdBQUc7UUFDSCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQzNCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBvaW50LCBSZWN0IH0gZnJvbSBcIi4vbWF0aC5qc1wiO1xuaW1wb3J0IHsgQ2FudmFzLCBnZXRDYW52YXNJbnN0YW5jZSB9IGZyb20gXCIuL2NhbnZhcy5qc1wiO1xuaW1wb3J0IHsgQ29sb3IsIGNyZWF0ZUNvbG9yLCB0b0NhbnZhc0NvbG9yIH0gZnJvbSBcIi4vY29sb3JzLmpzXCI7XG5pbXBvcnQgeyBDaGlsZHJlbkFycmF5IH0gZnJvbSBcIi4vY2hpbGRyZW5BcnJheS5qc1wiO1xuXG5sZXQgX2luc3RhbmNlSWQgPSAwO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgSW5zdGFuY2UgZXh0ZW5kcyBDaGlsZHJlbkFycmF5PEluc3RhbmNlPiB7XG4gICAgcHJpdmF0ZSBfY2FudmFzOiBDYW52YXMgfCBudWxsID0gbnVsbDtcbiAgICBwcml2YXRlIGZpcnN0VXBkYXRlID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBjbGlwU3Ryb2tlID0gZmFsc2U7XG4gICAgcHJvdGVjdGVkIF9kb250VHJhbnNsYXRlID0gZmFsc2U7XG4gICAgcHJvdGVjdGVkIGRyYXdDaGlsZEJvdHRvbSA9IHRydWU7XG4gICAgaW5kZXg6IG51bWJlcjtcbiAgICBkZXB0aCA9IDA7XG4gICAgcm90YXRpb24gPSAwO1xuICAgIHggPSAwO1xuICAgIHkgPSAwO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuaW5kZXggPSArK19pbnN0YW5jZUlkO1xuICAgICAgICB0aGlzLm9uQ3JlYXRlKCk7XG4gICAgfVxuXG4gICAgb25DcmVhdGUoKSB7fVxuICAgIG9uQmVnaW4oKSB7fVxuICAgIG9uRGVzdHJveSgpIHt9XG5cbiAgICBvblVwZGF0ZSgpIHt9XG5cbiAgICBvbkRyYXcoKSB7fVxuXG4gICAgX3VwZGF0ZShjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCkge1xuICAgICAgICBjdHguc2F2ZSgpO1xuICAgICAgICB0aGlzLm9uVXBkYXRlKCk7XG4gICAgICAgIGlmICghdGhpcy5fZG9udFRyYW5zbGF0ZSkgY3R4LnRyYW5zbGF0ZSh0aGlzLngsIHRoaXMueSk7XG4gICAgICAgIGlmICghdGhpcy5maXJzdFVwZGF0ZSkge1xuICAgICAgICAgICAgdGhpcy5vbkJlZ2luKCk7XG4gICAgICAgICAgICB0aGlzLmZpcnN0VXBkYXRlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5kcmF3Q2hpbGRCb3R0b20pIHRoaXMuY2hpbGRyZW4uc29ydCgoYSwgYikgPT4gYS5kZXB0aCAtIGIuZGVwdGgpLmZvckVhY2goY2hpbGQgPT4gY2hpbGQuX3VwZGF0ZShjdHgpKTtcbiAgICAgICAgdGhpcy5vbkRyYXcoKTtcbiAgICAgICAgaWYgKCF0aGlzLmRyYXdDaGlsZEJvdHRvbSkgdGhpcy5jaGlsZHJlbi5zb3J0KChhLCBiKSA9PiBhLmRlcHRoIC0gYi5kZXB0aCkuZm9yRWFjaChjaGlsZCA9PiBjaGlsZC5fdXBkYXRlKGN0eCkpO1xuICAgICAgICBjdHgucmVzdG9yZSgpO1xuICAgIH1cblxuICAgIHNldEZvbnRBbGlnbihhbGlnbjogQ2FudmFzVGV4dEFsaWduKSB7XG4gICAgICAgIHRoaXMuY3R4LnRleHRBbGlnbiA9IGFsaWduO1xuICAgIH1cblxuICAgIHNldEZpbGxDb2xvcihjb2xvcjogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuY3R4LmZpbGxTdHlsZSA9IGNvbG9yO1xuICAgIH1cblxuICAgIHNldFN0cm9rZUNvbG9yKGNvbG9yOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5jdHguc3Ryb2tlU3R5bGUgPSBjb2xvcjtcbiAgICB9XG5cbiAgICBzZXRDb2xvcihjb2xvcjogQ29sb3IpOiB2b2lkO1xuICAgIHNldENvbG9yKHI6IG51bWJlciwgZzogbnVtYmVyLCBiOiBudW1iZXIsIGE/OiBudW1iZXIpOiB2b2lkO1xuICAgIHNldENvbG9yKGNvbG9yOiBzdHJpbmcpOiB2b2lkO1xuICAgIHNldENvbG9yKGFyZzE6IENvbG9yIHwgbnVtYmVyIHwgc3RyaW5nLCBhcmcyPzogbnVtYmVyLCBhcmczPzogbnVtYmVyLCBhcmc0PzogbnVtYmVyKSB7XG4gICAgICAgIGlmICh0eXBlb2YgYXJnMSA9PT0gJ29iamVjdCcpIHRoaXMuc2V0Q29sb3IodG9DYW52YXNDb2xvcihhcmcxKSk7XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBhcmcxID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhpcy5zZXRGaWxsQ29sb3IoYXJnMSk7XG4gICAgICAgICAgICB0aGlzLnNldFN0cm9rZUNvbG9yKGFyZzEpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgdGhpcy5zZXRDb2xvcihjcmVhdGVDb2xvcihhcmcxLCBhcmcyIGFzIG51bWJlciwgYXJnMyBhcyBudW1iZXIsIGFyZzQgYXMgbnVtYmVyKSk7XG4gICAgfVxuXG4gICAgc2V0Rm9udEJhc2VsaW5lKGJhc2VsaW5lOiBDYW52YXNUZXh0QmFzZWxpbmUpIHtcbiAgICAgICAgdGhpcy5jdHgudGV4dEJhc2VsaW5lID0gYmFzZWxpbmU7XG4gICAgfVxuXG4gICAgc2V0Rm9udChmb250OiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5jdHguZm9udCA9IGZvbnQ7XG4gICAgfVxuXG4gICAgZmlsbFJlY3QoeDogbnVtYmVyLCB5OiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuY3R4LmZpbGxSZWN0KHggLSB3aWR0aCAvIDIsIHkgLSBoZWlnaHQgLyAyLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG5cbiAgICBmaWxsQ2lyY2xlKHg6IG51bWJlciwgeTogbnVtYmVyLCByYWRpdXM6IG51bWJlcikge1xuICAgICAgICB0aGlzLmN0eC5iZWdpblBhdGgoKTtcbiAgICAgICAgdGhpcy5jdHguYXJjKHgsIHksIHJhZGl1cywgMCwgMiAqIE1hdGguUEkpO1xuICAgICAgICB0aGlzLmN0eC5maWxsKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdHJva2UoKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaXBTdHJva2UpIHtcbiAgICAgICAgICAgIHRoaXMuY3R4LnNhdmUoKTtcbiAgICAgICAgICAgIHRoaXMuY3R4LmxpbmVXaWR0aCAqPSAyO1xuICAgICAgICAgICAgdGhpcy5jdHguY2xpcCgpO1xuICAgICAgICAgICAgdGhpcy5jdHguc3Ryb2tlKCk7XG4gICAgICAgICAgICB0aGlzLmN0eC5saW5lV2lkdGggLz0gMjtcbiAgICAgICAgICAgIHRoaXMuY3R4LnJlc3RvcmUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY3R4LnN0cm9rZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3Ryb2tlUmVjdCh4OiBudW1iZXIsIHk6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5jdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIHRoaXMuY3R4LnJlY3QoeCAtIHdpZHRoIC8gMiwgeSAtIGhlaWdodCAvIDIsIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgICB0aGlzLnN0cm9rZSgpO1xuICAgIH1cblxuICAgIHN0cm9rZUNpcmNsZSh4OiBudW1iZXIsIHk6IG51bWJlciwgcmFkaXVzOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5jdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIHRoaXMuY3R4LmFyYyh4LCB5LCByYWRpdXMsIDAsIDIgKiBNYXRoLlBJKTtcbiAgICAgICAgdGhpcy5zdHJva2UoKTtcbiAgICB9XG5cbiAgICBzZXRDbGlwU3Ryb2tlKGNsaXBTdHJva2U6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5jbGlwU3Ryb2tlID0gY2xpcFN0cm9rZTtcbiAgICB9XG5cbiAgICBkcmF3VGV4dCh4OiBudW1iZXIsIHk6IG51bWJlciwgLi4udGV4dDogYW55W10pIHtcbiAgICAgICAgdGhpcy5jdHguZmlsbFRleHQodGV4dC5qb2luKCcgJyksIHgsIHkpO1xuICAgIH1cblxuICAgIGRyYXdJbWFnZShpbWFnZTogSFRNTEltYWdlRWxlbWVudCwgeDogbnVtYmVyLCB5OiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZShpbWFnZSwgeCAtIHdpZHRoIC8gMiwgIHkgLSBoZWlnaHQgLyAyLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG5cbiAgICBzZXRBbHBoYSh2YWx1ZTogbnVtYmVyID0gMSkge1xuICAgICAgICB0aGlzLmN0eC5nbG9iYWxBbHBoYSA9IHZhbHVlO1xuICAgIH1cblxuICAgIG1lYXN1cmVUZXh0KC4uLnRleHQ6IGFueVtdKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmN0eC5tZWFzdXJlVGV4dCh0ZXh0LmpvaW4oJyAnKSk7XG4gICAgfVxuXG4gICAgZGVzdHJveShjbGVhbnVwID0gdHJ1ZSkge1xuICAgICAgICBpZiAoY2xlYW51cCkgdGhpcy5jaGlsZHJlbi5mb3JFYWNoKGNoaWxkID0+IGNoaWxkLmRlc3Ryb3koKSk7XG4gICAgICAgIHRoaXMub25EZXN0cm95KCk7XG4gICAgICAgIHRoaXMuY2FudmFzLmluc3RhbmNlcy5zcGxpY2UodGhpcy5jYW52YXMuaW5zdGFuY2VzLmluZGV4T2YodGhpcyksIDEpO1xuICAgIH1cblxuICAgIGdldFJlY3Qod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgeyBwb3MgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUmVjdChwb3MueCAtIHdpZHRoIC8gMiwgcG9zLnkgLSBoZWlnaHQgLyAyLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG5cbiAgICBpc0NsYXNzT2YoLi4uaW5zdGFuY2VzQ2xhc3NlczogRnVuY3Rpb25Db25zdHJ1Y3RvcltdKSB7XG4gICAgICAgIGZvciAoY29uc3QgY2xzIG9mIGluc3RhbmNlc0NsYXNzZXMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgY2xzKVxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBhZGRUb0NhbnZhcygpIHtcbiAgICAgICAgdGhpcy5jYW52YXMuYWRkQ2hpbGQodGhpcyk7XG4gICAgfVxuXG4gICAgZ2V0IHBvcygpIHtcbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5wYXJlbnQgPyB0aGlzLnBhcmVudC5wb3MgOiBuZXcgUG9pbnQoMCwgMCk7XG4gICAgICAgIHJldHVybiBuZXcgUG9pbnQodGhpcy54ICsgcGFyZW50LngsIHRoaXMueSArIHBhcmVudC55KTtcbiAgICB9XG5cbiAgICBzZXQgcG9zKHA6IFBvaW50KSB7XG4gICAgICAgIHRoaXMueCA9IHAueDtcbiAgICAgICAgdGhpcy55ID0gcC55O1xuICAgIH1cblxuICAgIGdldCBjYW52YXMoKSB7XG4gICAgICAgIGlmICghdGhpcy5fY2FudmFzKSB0aGlzLl9jYW52YXMgPSBnZXRDYW52YXNJbnN0YW5jZSgpO1xuICAgICAgICByZXR1cm4gdGhpcy5fY2FudmFzO1xuICAgIH1cblxuICAgIGdldCBjdHgoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbnZhcy5jdHg7XG4gICAgfVxufSJdfQ==